<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
	</head>
	<body>
	
		<canvas id="canvas" width="400" height="400"></canvas>
			
	</body>
	<script type="text/javascript" src="/build/wasmtest.js"></script>
	<script>
		// Key Input handling
		var forward = 0;
		var backward = 0;
		var left = 0;
		var right = 0;
		var jump = 0;
		var jumpReleased = 0;
		var startJumpTime = 0;
		document.addEventListener('keydown', function (event) {
			switch(event.keyCode)
			{
				case 87: forward  = 1; break;
				case 83: backward = 1; break;
				case 65: left     = 1; break;
				case 68: right    = 1; break;
				case 32: if(jump == 0) { startJumpTime = performance.now()/ 1000.0; } jump = 1; break;
			}
		});
		document.addEventListener('keyup', function (event) {
			switch(event.keyCode)
			{
				case 87: forward  = 0; break;
				case 83: backward = 0; break;
				case 65: left     = 0; break;
				case 68: right    = 0; break;
				case 32: jumpReleased = 1; break;
				
			}
		});

		// Wait for the engine to load
		Module.onRuntimeInitialized = function () {
			
			// Rev up the engine
			bindEngine();
			engine.init("canvas", 1024, 768, performance.now() / 1000.0);

			var shader = new shader_t("/src/phong.glsl");
			var skyboxshader = new shader_t("/src/skybox.glsl");

			// player
			var playerMesh = new model_t("/assets/sphere.obj")
			var playerTexture = new texture_t("/assets/sphere.png")

			var player = new prop_t();
			player.setInfo(playerMesh, playerTexture, shader);
			player.setScale(0.25, 0.25, 0.25);
			player.setOrigin(0, 0, 0);

			// Skybox
			var skyTexture = new texture_t("/assets/sky.png")
			var sky = new prop_t();
			engine.prop_setInfo(sky.id, engine.skyMesh(), skyTexture.id, skyboxshader.id);
			skyTexture.incRef();
			skyboxshader.incRef();

			sky.setScale(32,32,32);
			sky.setOrigin(0,0,0);

			// Ground
			var groundTexture = new texture_t("/assets/grid.png")
			var ground = new prop_t();
			engine.prop_setInfo(ground.id, engine.terrainTest(), groundTexture.id, shader.id);
			groundTexture.incRef();
			shader.incRef();

			ground.setScale(1, 1, 1);
			ground.setOrigin(0, 0, 0);

			// Sun data
			engine.sun_setColor(0.7,0.7,0.7,0.6);
			
			var yaw = 0;

			var lastFrameTime = 0;
			function drawFrame() {
				var curTime = performance.now() / 1000.0;
				var dt = curTime - lastFrameTime;
				engine.frame(curTime);

				engine.sun_setDir(1, 3*3.14/4, 3.14/8.0);
				
				// Movement handling
				var dx = (right - left);
				var dz = (backward - forward);
				var mag = Math.sqrt(dx*dx + dz*dz);
				if(mag != 0)
				{
					// Normalize movement
					dx = dx / mag;
					dz = dz / mag;

					// Rotate the player to face the moving direction
					yaw = Math.atan2(dz, dx)
				}

				var power = 0;
				if(jump == 1)
				{
					var holdtime = (curTime - startJumpTime);
					power = Math.sin(Math.min(holdtime / 3.0, 1.0) * 3.14);
				}
				
				// jump
				if(jumpReleased && jump)
				{
					jumpReleased = 0;
					jump = 0;
					
					var m = power * 3.0 / (1.0 / 60.0);
					dx *= m;
					dz *= m;
					
					engine.applyForce(dx, 4.0 / (1.0 / 60.0), dz)
				}
				
				// Move us
				engine.prop_sim(player);
				//player.setOrigin(x, y+0.25, z);

				player.setRotation(0, yaw, -power * 3.14 * 0.5)
				
				
				// Camera
				engine.camera_setOrigin(4,4,4);//x+4,4,z+4);//*Math.cos(curTime), 1, 4*Math.sin(curTime));
				engine.camera_setRotation(0.6,-3.14/4,0);
				engine.camera_apply();

				// Draw
				engine.prop_drawAll();

				lastFrameTime = curTime; 
				window.requestAnimationFrame(drawFrame)
			}
			drawFrame()

		};
		
		
	</script>
  </head>
</html>